apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: elastic-system

resources:
  - namespace.yaml
  - ingressroute.yaml
  - es-oidc-secret.sealedsecret.yaml
  - es-oidc-role-mapping.yaml

helmCharts:
  - name: eck-stack
    repo: https://helm.elastic.co
    version: 0.18.0
    releaseName: elastic
    namespace: elastic-system
    valuesInline:
      eck-elasticsearch:
        enabled: true
        fullnameOverride: elasticsearch
        version: 8.17.4
        annotations:
          eck.k8s.elastic.co/license: basic
        secureSettings:
          - secretName: es-oidc-secret
        nodeSets:
          - name: default
            count: 1
            config:
              node.store.allow_mmap: false
              xpack.security.authc.api_key.enabled: true
              xpack.security.authc.realms.oidc.oidc1:
                order: 2
                rp.client_id: "34c6eb1a085f70d21dc73432f2da027b620840657aa61d5e253fcd062f8f5bba"
                rp.response_type: code
                rp.redirect_uri: "https://kibana.<path:cert-manager:domain-config#domain>/api/security/oidc/callback"
                rp.post_logout_redirect_uri: "https://kibana.<path:cert-manager:domain-config#domain>/security/logged_out"
                op.issuer: "https://babybites.cloudflareaccess.com"
                op.authorization_endpoint: "https://babybites.cloudflareaccess.com/cdn-cgi/access/sso/oidc/34c6eb1a085f70d21dc73432f2da027b620840657aa61d5e253fcd062f8f5bba/authorization"
                op.token_endpoint: "https://babybites.cloudflareaccess.com/cdn-cgi/access/sso/oidc/34c6eb1a085f70d21dc73432f2da027b620840657aa61d5e253fcd062f8f5bba/token"
                op.jwkset_path: "https://babybites.cloudflareaccess.com/cdn-cgi/access/certs"
                op.userinfo_endpoint: "https://babybites.cloudflareaccess.com/cdn-cgi/access/sso/oidc/34c6eb1a085f70d21dc73432f2da027b620840657aa61d5e253fcd062f8f5bba/userinfo"
                claims.principal: email
                claims.groups: groups
                populate_user_metadata: true
            volumeClaimTemplates:
              - metadata:
                  name: elasticsearch-data
                spec:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: 50Gi
                  storageClassName: longhorn-single
            podTemplate:
              spec:
                containers:
                  - name: elasticsearch
                    resources:
                      requests:
                        memory: 2Gi
                        cpu: 500m
                      limits:
                        memory: 4Gi
                        cpu: 2
      eck-kibana:
        enabled: true
        fullnameOverride: kibana
        version: 8.17.4
        elasticsearchRef:
          name: elasticsearch
        count: 1
        config:
          server.publicBaseUrl: "https://kibana.<path:cert-manager:domain-config#domain>"
          xpack.security.authc.providers:
            oidc.oidc1:
              order: 0
              realm: oidc1
              description: "Log in with Cloudflare Access"
            basic.basic1:
              order: 1
          xpack.fleet.agents.elasticsearch.hosts: ["https://elasticsearch-es-http.elastic-system.svc:9200"]
          xpack.fleet.agents.fleet_server.hosts: ["https://fleet-server-agent-http.elastic-system.svc:8220"]
          xpack.fleet.packages:
            - name: system
              version: latest
            - name: elastic_agent
              version: latest
            - name: fleet_server
              version: latest
          xpack.fleet.agentPolicies:
            - name: Fleet Server on ECK policy
              id: eck-fleet-server
              namespace: default
              monitoring_enabled:
                - logs
                - metrics
              package_policies:
                - name: fleet_server-1
                  id: fleet_server-1
                  package:
                    name: fleet_server
            - name: Elastic Agent on ECK policy
              id: eck-agent
              namespace: default
              monitoring_enabled:
                - logs
                - metrics
              package_policies:
                - name: system-1
                  id: system-1
                  package:
                    name: system
        podTemplate:
          spec:
            containers:
              - name: kibana
                resources:
                  requests:
                    memory: 512Mi
                    cpu: 250m
                  limits:
                    memory: 1Gi
                    cpu: 1
      eck-fleet-server:
        enabled: true
        fullnameOverride: fleet-server
        version: 8.17.4
        kibanaRef:
          name: kibana
        elasticsearchRefs:
          - name: elasticsearch
        deployment:
          replicas: 1
          podTemplate:
            spec:
              serviceAccountName: fleet-server
              automountServiceAccountToken: true
              containers:
                - name: agent
                  resources:
                    requests:
                      memory: 256Mi
                      cpu: 100m
                    limits:
                      memory: 512Mi
                      cpu: 500m
      eck-agent:
        enabled: false
      eck-beats:
        enabled: false
      eck-logstash:
        enabled: false
      eck-apm-server:
        enabled: false
      eck-enterprise-search:
        enabled: false
