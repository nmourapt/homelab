apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: synology-csi

resources:
  - namespace.yaml
  - client-info.sealedsecret.yaml

helmGlobals:
  chartHome: charts

helmCharts:
  - name: synology-csi
    releaseName: synology-csi
    namespace: synology-csi
    valuesInline:
      clientInfoSecret:
        create: false
        name: client-info-secret
      images:
        plugin:
          supportChrootDir: true
      storageClasses:
        synology-iscsi:
          reclaimPolicy: Retain
          parameters:
            dsm: '192.168.202.1'
            fsType: ext4
            location: '/volume2'

# Talos doesn't ship /usr/bin/env â€” inject an init container to create it on the host
patches:
  - target:
      kind: DaemonSet
      name: synology-csi-node
    patch: |
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: synology-csi-node
      spec:
        template:
          spec:
            initContainers:
              - name: create-host-env
                image: busybox:stable
                command:
                  - sh
                  - -c
                  - |
                    if [ ! -f /host/usr/bin/env ]; then
                      mkdir -p /host/usr/bin
                      printf '#!/bin/sh\nexec "$@"\n' > /host/usr/bin/env
                      chmod 755 /host/usr/bin/env
                    fi
                volumeMounts:
                  - name: host-root
                    mountPath: /host
